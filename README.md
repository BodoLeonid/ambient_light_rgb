# Screen Color Tracker & BLE LED Controller

## Описание

Система для анализа доминирующего цвета на экране компьютера и передачи его на BLE-устройство (светодиодные ленты, лампы) в реальном времени.

## Функциональность

- Анализ цвета экрана с частотой до 30 кадров в секунду
- Определение доминирующего цвета с фильтрацией шумов
- Плавные переходы между цветами
- Поддержка Bluetooth Low Energy устройств
- Кроссплатформенность (Windows, macOS, Linux)

## Структура проекта

```
screen_color_tracker/
├── main.py              # Точка входа приложения
├── config.py            # Конфигурационные параметры
├── color_processor.py   # Обработка и анализ цвета
├── ble_client.py        # Работа с BLE устройством
├── utils.py             # Вспомогательные функции
└── requirements.txt     # Зависимости проекта
```

## Установка

### Требования

- Python 3.8 или выше
- Bluetooth адаптер с поддержкой BLE

### Установка зависимостей

```bash
pip install -r requirements.txt
```

#### Дополнительно для macOS:
```bash
pip install bleak[macos]
pip install pyobjc-core pyobjc-framework-Cocoa
```

#### Для Linux (Ubuntu/Debian):
```bash
sudo apt-get install python3-dev python3-pip libbluetooth-dev
```

## Настройка

### 1. Настройка BLE устройства

Отредактируйте файл `config.py`:

```python
# Замените на адрес вашего BLE устройства
DEVICE_ADDRESS = "ВАШ_МАК_АДРЕС"

# Для поиска устройств используйте:
# python -c "import asyncio; from bleak import BleakScanner; asyncio.run(BleakScanner.discover())"
```

### 2. Конфигурационные параметры

Основные параметры в `config.py`:

| Параметр | Значение | Описание |
|----------|----------|----------|
| `DOWNSCALE_FACTOR` | 16 | Уменьшение скриншота для производительности |
| `MIN_BRIGHTNESS` | 0.15 | Минимальная яркость цвета |
| `MAX_BRIGHTNESS` | 0.95 | Максимальная яркость цвета |
| `MIN_SATURATION` | 0.2 | Минимальная насыщенность цвета |
| `COLOR_CHANGE_THRESHOLD` | 30 | Порог изменения цвета для перехода |
| `TRANSITION_STEPS` | 10 | Количество шагов плавного перехода |

## Использование

### Запуск приложения

```bash
python main.py
```

### Остановка
Нажмите `Ctrl+C` для корректного завершения работы.

## Принцип работы

1. **Захват экрана**: Приложение делает скриншот всей области экрана
2. **Обработка изображения**: 
   - Уменьшение разрешения для оптимизации
   - Фильтрация пикселей по яркости и насыщенности
   - Вычисление медианного цвета
3. **Коррекция цвета**: Усиление насыщенности и яркости
4. **Передача данных**: Отправка цвета на BLE устройство в формате HEX

### Фильтрация цветов

Исключаются из анализа:
- Полностью черные пиксели (R,G,B < 10)
- Цвета с яркостью менее 15% и более 95%
- Цвета с насыщенностью менее 20%

### Формат BLE команды

Команда отправляется в HEX формате:
```
7E 00 05 03 RR GG BB 00 EF
```
где `RR GG BB` - значения красного, зеленого и синего каналов.

## Решение проблем

### Общие проблемы

1. **"Permission denied" на macOS**
   - Предоставьте разрешение на запись экрана в System Settings → Security & Privacy → Screen Recording

2. **Bluetooth устройство не найдено**
   - Убедитесь, что устройство включено и доступно для подключения
   - Проверьте MAC адрес в `config.py`

3. **Высокая загрузка CPU**
   - Увеличьте `DOWNSCALE_FACTOR` в `config.py`
   - Добавьте задержку в основном цикле

### Оптимизация производительности

Для увеличения производительности:
```python
# В config.py
DOWNSCALE_FACTOR = 32  # Увеличить с 16 до 32
TRANSITION_STEPS = 5   # Уменьшить количество шагов перехода
```

## Поддерживаемые устройства

Система протестирована с:
- Светодиодными лентами с BLE контроллером
- Умными лампами, поддерживающими BLE
- Устройствами, использующими протокол аналогичный Magic Home

## Безопасность

- Приложение работает локально
- Не передает данные в интернет
- Требует явного разрешения на доступ к экрану

## Лицензия

MIT License